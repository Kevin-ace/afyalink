<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - AfyaLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/profile.css" />
    <link rel="stylesheet" href="../css/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
      <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
          <img src="../assets/icons/afyalogo.png" alt="AfyaLink Logo" width="40" height="40" class="me-2">
          <span class="brand-name">AfyaLink</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="facilities.html"><i class="fas fa-hospital me-1"></i>Facilities</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="emergency.html"><i class="fas fa-ambulance me-1"></i>Emergency</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="insurance.html"><i class="fas fa-shield-alt me-1"></i>Insurance</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="services.html"><i class="fas fa-stethoscope me-1"></i>Services</a>
            </li>
            <li class="nav-item position-relative me-2">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell position-relative">
                  <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                    <span class="visually-hidden">New notifications</span>
                  </span>
                </i>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img id="userAvatar" src="../assets/icons/medical-symbol.png" alt="Profile" class="rounded-circle me-2" width="32" height="32">
                <span class="d-none d-md-inline" id="userName">Loading...</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li><a class="dropdown-item active" href="profile.html"><i class="fas fa-user me-2"></i>My Profile</a></li>
                <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="logout.html"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-5 pt-4">
      <div class="row">
        <!-- Profile Card -->
        <div class="col-md-4 mb-4">
          <div class="card profile-card h-100">
            <div class="card-body text-center">
              <div class="profile-image mb-4">
                <img id="profileAvatar" src="../assets/icons/medical-symbol.png" alt="Profile Picture" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="document.getElementById('avatarInput').click()">
                  <i class="fas fa-camera me-1"></i>Change Photo
                </button>
                <input type="file" id="avatarInput" hidden accept="image/*">
              </div>
              <h3 class="card-title" id="fullName">Loading...</h3>
              <p class="card-text text-muted" id="email">loading@example.com</p>
              <p class="card-text" id="phoneNumber">Loading...</p>
              <div class="mt-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                  <i class="fas fa-edit me-1"></i>Edit Profile
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal Information -->
        <div class="col-md-8">
          <div class="card mb-4">
            <div class="card-header">
              <h4 class="mb-0">Personal Information</h4>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>ID Number</h6>
                  <p id="idNumber" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Emergency Contact</h6>
                  <p id="emergencyContact" class="text-muted">Loading...</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Insurance Provider</h6>
                  <p id="insuranceProvider" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Insurance Number</h6>
                  <p id="insuranceNumber" class="text-muted">Loading...</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>SHA Membership</h6>
                  <p id="shaMembership" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>SHA Number</h6>
                  <p id="shaNumber" class="text-muted">Loading...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Medical Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h4 class="mb-0">Medical Information</h4>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Blood Type</h6>
                  <p id="bloodType" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Medical Conditions</h6>
                  <p id="medicalConditions" class="text-muted">Loading...</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Allergies</h6>
                  <p id="allergies" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Medications</h6>
                  <p id="medications" class="text-muted">Loading...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Emergency Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h4 class="mb-0">Emergency Information</h4>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Next of Kin</h6>
                  <p id="nextOfKin" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Relationship</h6>
                  <p id="relationship" class="text-muted">Loading...</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Contact Number</h6>
                  <p id="kinContact" class="text-muted">Loading...</p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Alternative Contact</h6>
                  <p id="altContact" class="text-muted">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editProfileForm">
              <!-- Personal Information -->
              <div class="card mb-3">
                <div class="card-header">
                  <h5 class="mb-0">Personal Information</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="editPhone" class="form-label">Phone Number</label>
                      <input type="tel" class="form-control" id="editPhone" placeholder="Enter phone number">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="editEmergencyContact" class="form-label">Emergency Contact</label>
                      <input type="text" class="form-control" id="editEmergencyContact" placeholder="Enter emergency contact">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Insurance Information -->
              <div class="card mb-3">
                <div class="card-header">
                  <h5 class="mb-0">Insurance Information</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="editInsuranceProvider" class="form-label">Insurance Provider</label>
                      <input type="text" class="form-control" id="editInsuranceProvider" placeholder="Enter insurance provider">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="editInsuranceNumber" class="form-label">Insurance Number</label>
                      <input type="text" class="form-control" id="editInsuranceNumber" placeholder="Enter insurance number">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Medical Information -->
              <div class="card mb-3">
                <div class="card-header">
                  <h5 class="mb-0">Medical Information</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="editBloodType" class="form-label">Blood Type</label>
                      <input type="text" class="form-control" id="editBloodType" placeholder="Enter blood type">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="editMedicalConditions" class="form-label">Medical Conditions</label>
                      <textarea class="form-control" id="editMedicalConditions" rows="2" placeholder="Enter medical conditions"></textarea>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="editAllergies" class="form-label">Allergies</label>
                      <textarea class="form-control" id="editAllergies" rows="2" placeholder="Enter allergies"></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="editMedications" class="form-label">Medications</label>
                      <textarea class="form-control" id="editMedications" rows="2" placeholder="Enter medications"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="fas fa-exclamation-circle text-danger me-2"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        An error occurred. Please try again.
      </div>
    </div>

    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="fas fa-check-circle text-success me-2"></i>
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        Profile updated successfully!
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      import { AuthService } from '../js/auth-service.js';
      import { CONFIG } from '../js/config.js';
      import { Logger } from '../js/services/logger.js';

      const toastBootstrap = {
          error: new bootstrap.Toast(document.getElementById('errorToast')),
          success: new bootstrap.Toast(document.getElementById('successToast'))
      };

      async function loadUserProfile() {
          try {
              document.getElementById('profileLoading').style.display = 'block';
              
              const userData = await AuthService.request(
                  CONFIG.API.ENDPOINTS.AUTH.PROFILE,
                  'GET',
                  null,
                  true
              );

              // Update profile information
              document.getElementById('fullName').textContent = `${userData.first_name} ${userData.last_name}`;
              document.getElementById('email').textContent = userData.email;
              document.getElementById('phoneNumber').textContent = userData.phone_number || 'Not provided';
              document.getElementById('idNumber').textContent = userData.id_number || 'Not provided';
              
              // Personal Information
              document.getElementById('emergencyContact').textContent = userData.emergency_contact || 'Not provided';
              
              // Insurance Information
              document.getElementById('insuranceProvider').textContent = userData.insurance_provider || 'Not provided';
              document.getElementById('insuranceNumber').textContent = userData.insurance_number || 'Not provided';
              
              // SHA Information
              document.getElementById('shaMembership').textContent = userData.sha_membership || 'Not provided';
              document.getElementById('shaNumber').textContent = userData.sha_number || 'Not provided';
              
              // Medical Information
              document.getElementById('bloodType').textContent = userData.blood_type || 'Not provided';
              document.getElementById('medicalConditions').textContent = userData.medical_conditions || 'Not provided';
              document.getElementById('allergies').textContent = userData.allergies || 'Not provided';
              document.getElementById('medications').textContent = userData.medications || 'Not provided';
              
              // Emergency Information
              document.getElementById('nextOfKin').textContent = userData.next_of_kin || 'Not provided';
              document.getElementById('relationship').textContent = userData.relationship || 'Not provided';
              document.getElementById('kinContact').textContent = userData.kin_contact || 'Not provided';
              document.getElementById('altContact').textContent = userData.alt_contact || 'Not provided';
              
              if (userData.avatar) {
                  document.getElementById('profileAvatar').src = userData.avatar;
                  document.getElementById('userAvatar').src = userData.avatar;
              }
              
              // Pre-fill edit form
              document.getElementById('editPhone').value = userData.phone_number || '';
              document.getElementById('editEmergencyContact').value = userData.emergency_contact || '';
              document.getElementById('editInsuranceProvider').value = userData.insurance_provider || '';
              document.getElementById('editInsuranceNumber').value = userData.insurance_number || '';
              document.getElementById('editBloodType').value = userData.blood_type || '';
              document.getElementById('editMedicalConditions').value = userData.medical_conditions || '';
              document.getElementById('editAllergies').value = userData.allergies || '';
              document.getElementById('editMedications').value = userData.medications || '';

              Logger.log(Logger.INFO, 'Profile loaded successfully', { userId: userData.id });
              
          } catch (error) {
              console.error('Error loading profile:', error);
              Logger.error('Error loading profile', error);
              
              if (error.status === 401) {
                  toastBootstrap.error.show();
                  setTimeout(() => {
                      window.location.href = '/login.html';
                  }, 2000);
              } else {
                  document.getElementById('errorToast').querySelector('.toast-body').textContent = 
                      error.message || 'Failed to load profile data';
                  toastBootstrap.error.show();
              }
          } finally {
              document.getElementById('profileLoading').style.display = 'none';
          }
      }

      // Load profile when page loads
      document.addEventListener('DOMContentLoaded', async () => {
          try {
              // Check if user is authenticated
              if (!AuthService.getAuthToken()) {
                  toastBootstrap.error.show();
                  setTimeout(() => {
                      window.location.href = '/login.html';
                  }, 2000);
                  return;
              }
              
              await loadUserProfile();
          } catch (error) {
              console.error('Error initializing profile page:', error);
              Logger.error('Error initializing profile page', error);
              toastBootstrap.error.show();
          }
      });

      // Handle avatar upload
      document.getElementById('avatarInput').addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (file) {
              try {
                  const formData = new FormData();
                  formData.append('avatar', file);
                  
                  await AuthService.request(
                      CONFIG.API.ENDPOINTS.AUTH.PROFILE,
                      'PATCH',
                      formData,
                      true
                  );
                  
                  await loadUserProfile(); // Reload profile to show new avatar
                  toastBootstrap.success.show();
              } catch (error) {
                  console.error('Error uploading avatar:', error);
                  Logger.error('Error uploading avatar', error);
                  document.getElementById('errorToast').querySelector('.toast-body').textContent = 
                      error.message || 'Failed to upload avatar';
                  toastBootstrap.error.show();
              }
          }
      });

      // Update profile function
      async function updateProfile() {
          try {
              const updatedData = {
                  phone_number: document.getElementById('editPhone').value,
                  emergency_contact: document.getElementById('editEmergencyContact').value,
                  insurance_provider: document.getElementById('editInsuranceProvider').value,
                  insurance_number: document.getElementById('editInsuranceNumber').value,
                  blood_type: document.getElementById('editBloodType').value,
                  medical_conditions: document.getElementById('editMedicalConditions').value,
                  allergies: document.getElementById('editAllergies').value,
                  medications: document.getElementById('editMedications').value
              };

              await AuthService.request(
                  CONFIG.API.ENDPOINTS.AUTH.PROFILE,
                  'PATCH',
                  JSON.stringify(updatedData),
                  true
              );

              await loadUserProfile(); // Reload profile to show updates
              toastBootstrap.success.show();
              bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          } catch (error) {
              console.error('Error updating profile:', error);
              Logger.error('Error updating profile', error);
              document.getElementById('errorToast').querySelector('.toast-body').textContent = 
                  error.message || 'Failed to update profile';
              toastBootstrap.error.show();
          }
      }
    </script>
  </body>
</html>
